services:
  # MariaDB Database (설정: secret/mariadb.json)
  mariadb:
    image: mariadb:10.11
    container_name: kraft-mariadb
    env_file: .env
    environment:
      - MARIADB_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD:-root}
      - MARIADB_DATABASE=${MARIADB_DATABASE:-kraft_db}
      - MARIADB_USER=${MARIADB_USER:-kraft_user}
      - MARIADB_PASSWORD=${MARIADB_PASSWORD:-Gkstmvns1!}
      - TZ=Asia/Seoul
    ports:
      - "3306:3306"
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./docker/mariadb/init:/docker-entrypoint-initdb.d:ro
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_uca1400_ai_ci
      - --skip-character-set-client-handshake
      - --max-connections=200
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-uroot", "-p${MARIADB_ROOT_PASSWORD:-root}"]
      interval: 10s
      timeout: 5s
      start_period: 30s
      retries: 10
    restart: unless-stopped
    networks:
      - kraft_network

  # Redis Cache (설정: secret/redis.json)
  redis:
    image: redis:7-alpine
    container_name: kraft-redis
    env_file: .env
    command: redis-server --appendonly yes
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      start_period: 10s
      retries: 5
    restart: unless-stopped
    networks:
      - kraft_network

  # MinIO Object Storage (설정: secret/minio.json)
  minio:
    image: minio/minio:latest
    container_name: kraft-minio
    env_file: .env
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-kraft_minio}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-change-me-minio}
      - MINIO_REGION=${MINIO_REGION:-us-east-1}
    ports:
      - "9000:9000"  # API
      - "9001:9001"  # Console
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      start_period: 30s
      retries: 5
    restart: unless-stopped
    networks:
      - kraft_network

  # Spring Boot Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: kraft-app
    env_file: .env
    environment:
      # Spring Profiles
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:dev}

      # Database Configuration
      - SPRING_DATASOURCE_URL=jdbc:mariadb://mariadb:3306/${MARIADB_DATABASE:-kraft_db}?useUnicode=true&characterEncoding=utf8mb4&serverTimezone=Asia/Seoul
      - SPRING_DATASOURCE_USERNAME=${MARIADB_USER:-kraft_user}
      - SPRING_DATASOURCE_PASSWORD=${MARIADB_PASSWORD:-Gkstmvns1!}
      - DB_HOST=mariadb
      - DB_PORT=3306
      - DB_NAME=${MARIADB_DATABASE:-kraft_db}
      - DB_USER=${MARIADB_USER:-kraft_user}
      - DB_PASSWORD=${MARIADB_PASSWORD:-Gkstmvns1!}

      # Redis Configuration
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - SPRING_REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_HOST=redis
      - REDIS_PORT=6379

      # MinIO Configuration
      - MINIO_ENDPOINT=http://minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-kraft_minio}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-change-me-minio}
      - MINIO_REGION=${MINIO_REGION:-us-east-1}

      # OAuth2 Configuration (from secret/google_secret.json & naver_secret.json)
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - NAVER_CLIENT_ID=${NAVER_CLIENT_ID}
      - NAVER_CLIENT_SECRET=${NAVER_CLIENT_SECRET}

      # Application
      - TZ=Asia/Seoul
    ports:
      - "8080:8080"
    depends_on:
      mariadb:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    networks:
      - kraft_network

networks:
  kraft_network:
    driver: bridge
    name: kraft_network

volumes:
  mariadb_data:
    driver: local
    name: kraft_mariadb_data
  redis_data:
    driver: local
    name: kraft_redis_data
  minio_data:
    driver: local
    name: kraft_minio_data
